# LogRhythm Archive Retention Manager

> **Versioning Note:** The authoritative version is defined in `ArchiveRetention.ps1` (`$SCRIPT_VERSION`).

## Disclaimer

**Use at your own risk.** This retention script is designed to delete specific files in high-volume according to the execution parameters you provide. You are solely responsible for ensuring you have good backups and thoroughly testing and validating this script, and your chosen parameters, in a non-production environment before any production use. Whether due to misconfiguration (such as setting an overly aggressive retention period) or if there are any bugs in the script, the risk of data loss or unintended deletions is entirely yours. The authors and contributors are not liable for any damages, data loss, or other consequences resulting from the use or misuse of this script.

---

This is a high-performance PowerShell script for managing the retention of files, particularly LogRhythm Inactive Archives. It automates the cleanup of old archive files while providing detailed logging and reporting. The latest version includes performance optimizations and enhanced logging capabilities.

This script is specifically designed for use with LogRhythm (LR7 SIEM) environments, targeting the files generated by the [Data Processor's InactiveArchivePath value](https://docs.logrhythm.com/lrsiem/docs/change-archive-location). LR7 Inactive Archives contain the raw logs collected by LR System Monitor Agents and saved by the LogRhythm Mediator Server Service. The LR7 SIEM does not delete these files and so users must manage its retention using other methods, such as this script. Retaining these archive log files (.lca) allows you to utilize LogRhythm's SecondLook Wizard to reprocess and reindex the logs back into the SIEM, if needed. Inactive Archives do not affect the current searchability (indexing) of the SIEM. **Warning:** Do not configure this script to target LogRhythm's Active Archives (.lua). These are configured within the product with a value of 1 to 7 days and then automatically age into the Inactive Archive path.

## Features

- **Safe Execution**: Dry-run mode by default, requires `-Execute` flag for actual deletions
- **Minimum Retention Enforcement**: The script will never delete files newer than $MINIMUM_RETENTION_DAYS, which is hard-coded in the script for safety (default: 90 days, configurable by editing the script). If you specify a lower value with `-Execute`, the script will log a warning and enforce the minimum. Dry-run mode will warn but proceed with any value, showing what would be in scope for deletion with the given parameters.
- **Comprehensive Logging & Auditing**: All script activity is logged with timestamps, including file statistics, progress updates, error handling, and detailed output with `-Verbose`. In execute mode, every file deleted is also recorded in a dedicated audit log (`retention_actions/retention_*.log`) for compliance and traceability. Dry-run mode will show what would be deleted, but only actual deletions are audit-logged.
- **Flexible Configuration**: Customize retention periods (e.g., `-RetentionDays 1095`), archive locations (`-ArchivePath`), and file types to include (default: `.lca`).
- **Performance Optimized**: Efficient file scanning and processing, with real-time progress updates and robust error handling.

## Requirements

- Windows Server
- PowerShell 5.1 or later
- Appropriate permissions on LogRhythm archive directories (whether local or via a UNC share)
- Sufficient disk space for log files

## Installation

1. Copy the `ArchiveRetention.ps1` script to the Windows server
2. Place it in a directory with appropriate permissions (e.g., `C:\LogRhythm\Scripts\LRArchiveRetention\`) so that only authorized administrators can modify or execute the script
3. Ensure the script has read/write permissions to the archive directories

## Usage

```powershell
# Show help and available parameters
.\ArchiveRetention.ps1 -Help

# Dry run (shows a summary of what would be deleted with 90 day retention; if you want to list all files, add -Verbose)
.\ArchiveRetention.ps1 -ArchivePath "D:\LogRhythmArchives\InactiveTest" -RetentionDays 90

# Actual execution (deletes files) with -Execute parameter
.\ArchiveRetention.ps1 -ArchivePath "D:\LogRhythmArchives\InactiveTest" -RetentionDays 90 -Execute

# Example output from dry run:
# Found 6,484 files (2.3 GB) that would be processed (older than 90 days)
# Oldest file: 20250303_1_1_1_638765599202720081.lca (Last modified: 03/03/2025)
# Newest file: 20250314_1_1_1_638775155530957788.lca (Last modified: 03/14/2025)

# Process a specific archive directory for 3 years
.\ArchiveRetention.ps1 -ArchivePath "D:\LogRhythmArchives\InactiveTest" -RetentionDays 1095 -Execute

# Process with custom log location
.\ArchiveRetention.ps1 -ArchivePath "D:\LogRhythmArchives" -RetentionDays 365 -LogPath "C:\Logs\archive_retention.log" -Execute
```

### Scheduled Task Example

Create a scheduled task to run the script weekly:

```powershell
$action = New-ScheduledTaskAction -Execute 'PowerShell.exe' -Argument '-NoProfile -ExecutionPolicy Bypass -File "C:\LogRhythm\Scripts\ArchiveV2\ArchiveRetention.ps1" -ArchivePath "D:\LogRhythmArchives" -RetentionDays 365 -Execute'
$trigger = New-ScheduledTaskTrigger -Weekly -DaysOfWeek Sunday -At 2am
$settings = New-ScheduledTaskSettingsSet -StartWhenAvailable -DontStopOnIdleEnd -RunOnlyIfNetworkAvailable
Register-ScheduledTask -Action $action -Trigger $trigger -Settings $settings -TaskName "LogRhythm Archive Retention" -Description "Runs LogRhythm archive retention weekly to ensure InactiveArchives are not retained past the specified number of days" -User "SYSTEM" -RunLevel Highest
```

> **Note**: Run the scheduled task as SYSTEM or a service account with appropriate permissions.

## Parameters

| Parameter         | Description                                               | Default/Required         |
|-------------------|----------------------------------------------------------|-------------------------|
| `-ArchivePath`    | Path to LogRhythm archive directory                      | Required                |
| `-RetentionDays`  | Number of days to retain archive files                   | Required                |
| `-Execute`        | Perform actual file deletions (otherwise dry-run)        | `$false`                |
| `-LogPath`        | Path to log file                                         | `./ArchiveRetention.log`|
| `-MaxRetries`     | Maximum number of retries for failed operations          | `3`                     |
| `-RetryDelaySeconds` | Delay between retry attempts in seconds               | `1`                     |
| `-SkipEmptyDirCleanup` | Skip empty directory cleanup after file processing   | `$false`                |
| `-IncludeFileTypes` | File types to include (e.g., '.lca', '.txt'). Defaults to '.lca'. | `'.lca'`                |
| `-Verbose`        | Detailed or debug logging level                          | Optional                |

## Best Practices

1. **Backup first**: Ensure you have backups before running with `-Execute`
2. **Always test first**: Run without `-Execute` and with `-Verbose` to verify which files will be deleted
3. **Start with a subset**: Test with smaller directories before running against a massive dataset
4. **Review logs**: Check the main script log (`script_logs/ArchiveRetention.log`) after each run for any warnings or errors and if you ran with `-Execute` check the retention action logs (`retention_actions/retention_*.log`)
5. **Schedule during off-peak**: Run during maintenance windows but not at the same time as other processes to minimize impact
6. **Monitor progress**: The script provides real-time progress updates
7. **Archive logs**: Regularly back up all script logs for compliance, auditing, and troubleshooting. This includes:
   - The main script log (`script_logs/ArchiveRetention.log`)
   - Previous main script logs (`script_logs/ArchiveRetention_*.log`)
   - Retention action logs (`retention_actions/retention_*.log`)
8. **Expect longer initial run times**: The first time you run the script (especially with `-Execute`), it may take significantly longer than subsequent runs, since it will likely have much more data to delete. Consider staging a few initial runs with larger retention days before getting to your target and setting up a scheduled task. Regular daily or weekly scheduled runs will typically be much faster.
9. **Always use UNC paths for network shares**: Use paths like `\\server\share\folder` instead of mapped drives (e.g., `Z:`). Mapped drives are session-specific and may not be available in scheduled tasks, SSH, or service contexts.
10. **Run as a user with appropriate permissions**: Ensure the account running the script has read/write access to the archive or network share. For UNC paths, verify permissions on the share and NTFS.
11. **For scheduled tasks or services**: Use UNC paths and run as a service account with explicit permissions to the share. Avoid relying on mapped drives.
## Troubleshooting

### Common Issues

1. **Access Denied**
   - Ensure the script is run with administrative privileges
   - Verify the account has Full Control permissions on the archive directory or network share
   - For UNC paths, check both share and NTFS permissions
   - If running as a service, scheduled task, or via SSH, ensure the account context has access

2. **Files Not Being Deleted**
   - Check if the files are older than the specified retention period
   - Verify the path is correct and accessible
   - Ensure no other processes have the files locked

3. **Mapped drives not available**
   - Mapped drives (e.g., `Z:`) are only available in the session where they were created
   - Use UNC paths for reliability, especially in scheduled tasks, SSH, or service contexts
   - If you must use a mapped drive, map it at the start of the script using `net use` or `New-PSDrive`

4. **'The system cannot find the file specified'**
   - This may indicate a broken shortcut, inaccessible subfolder, or network hiccup
   - Try running the script on subfolders to isolate the issue
   - Check for long paths or special characters in file/folder names
   - Review the main script log (`script_logs/ArchiveRetention.log`) for the full exception and stack trace

5. **'Access is denied'**
   - The user running the script does not have permissions to the share or folder
   - Check both share and NTFS permissions
   - If using a service account, ensure it is granted access

6. **Performance Issues**
   - For large directories, ensure the server and network can handle the load
   - Avoid running during peak hours

7. **Log File Growth**
   - The main script log (`script_logs/ArchiveRetention.log`) automatically rotates when it reaches 10MB
   - Previously ran script logs are saved as `script_logs/ArchiveRetention_*.log` (timestamped)
   - Up to 10 rotated main script log files are kept by default
   - Retention action/audit logs (`retention_actions/retention_*.log`) are not rotated by default and should be managed/archived as needed

8. **Minimum retention not honored:**
   - The script will never delete files newer than 90 days, regardless of the value you specify with `-Execute`.
   - Dry-run will show what would be deleted for any value, but will warn if below 90.

- **Access Denied**: Ensure the script runs with appropriate permissions
- **No files processed**: Verify the `-ArchivePath` is correct and contains `.lca` files
- **Unexpected deletions**: Always test without the `-Execute` flag and with `-Verbose` first to review actions
- **Log file issues**: Check disk space and permissions for the log directory

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

**Disclaimer:**  
This script is provided "as is", without warranty of any kind. Use at your own risk.

## Support

Contributions are welcome! Please follow the standard GitHub fork and pull request workflow.

## Author

Nathan Church  
Exabeam Professional Services

## Logging

The script generates several types of log files for auditing, troubleshooting, and compliance:

| Log File Location                        | What It Contains                                 |
|-------------------------------------------|--------------------------------------------------|
| `script_logs/ArchiveRetention.log`        | Main script log (current run): all script activity, configuration, progress, warnings, errors, and summary information. Use this for troubleshooting and reviewing script runs. |
| `script_logs/ArchiveRetention_*.log`      | Rotated/archived main logs (previous runs): when the main log exceeds 10MB, it is archived with a timestamped filename. Preserves historical logs for compliance and troubleshooting. |
| `retention_actions/retention_*.log`       | Retention action/audit logs: in execute mode, every file deleted is recorded here for compliance, audit trails, and forensic review. |

**Best Practice:** Regularly back up all script logs for compliance, auditing, and troubleshooting.