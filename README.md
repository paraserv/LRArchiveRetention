# LogRhythm Archive Retention Manager

> **Versioning Note:** The authoritative version is defined in `ArchiveRetention.ps1` (`$SCRIPT_VERSION`).

## Disclaimer

This script is provided "as is", without warranty of any kind, express or implied.  
**Use at your own risk.** You are solely responsible for testing and validating this script in a non-production environment before deploying it in production.  
The authors and contributors are not liable for any damages or data loss resulting from the use or misuse of this script.

A high-performance PowerShell script for managing LogRhythm (LR7 SIEM) archive retention policies, specifically the files generated by the [Data Processor's InactiveArchivePath value](https://docs.logrhythm.com/lrsiem/docs/change-archive-location). This script automates the cleanup of old archive files while providing detailed logging and reporting. The latest version includes performance optimizations and enhanced logging capabilities.

## Features

- **Safe Execution**: Dry-run mode by default, requires `-Execute` flag for actual deletions
- **Minimum Retention Enforcement**: The script will never delete files newer than $MINIMUM_RETENTION_DAYS, which is hard-coded in the script for safety (default: 90 days, configurable by editing the script). If you specify a lower value with `-Execute`, the script will log a warning and enforce the minimum. Dry-run mode will warn but proceed with any value, showing what would be deleted with the given parameters.
- **High Performance**: Efficient processing of large numbers of archive files
- **Detailed Logging**: Comprehensive logging with timestamps and operation details
- **Progress Tracking**: Real-time progress updates during execution
- **Error Handling**: Robust error handling and recovery mechanisms
- **Flexible Configuration**: Customize retention periods and archive locations
- **Verbose Output**: Detailed console output with `-Verbose` flag
- **Performance Optimized**: Efficient file scanning and processing
- **Enhanced Logging**: Detailed file statistics and progress tracking

## Requirements

- Windows Server with LogRhythm Archive Manager
- PowerShell 5.1 or later
- Appropriate permissions on LogRhythm archive directories
- Sufficient disk space for log files

## Installation

1. Copy the `ArchiveRetention.ps1` script to your LogRhythm server
2. Place it in a directory with restricted permissions (e.g., `C:\LogRhythm\Scripts\LRArchiveRetention\`) so that only authorized administrators can modify or execute the script.
3. Ensure the script has read/write permissions to the archive directories

## Usage

### Basic Usage

```powershell
# Show help and available parameters
.\ArchiveRetention.ps1 -Help

# Dry run (shows what would be deleted)
.\ArchiveRetention.ps1 -ArchivePath "D:\LogRhythmArchives\InactiveTest" -RetentionDays 88 -Verbose

# Actual execution (deletes files)
.\ArchiveRetention.ps1 -ArchivePath "D:\LogRhythmArchives\InactiveTest" -RetentionDays 88 -Execute -Verbose

# Example output from dry run:
# Found 6,484 files (2.3 GB) that would be processed (older than 88 days)
# Oldest file: 20250303_1_1_1_638765599202720081.lca (Last modified: 03/02/2025)
# Newest file: 20250314_1_1_1_638775155530957788.lca (Last modified: 03/13/2025)
```

### Advanced Examples

```powershell
# Process a specific archive directory
.\ArchiveRetention.ps1 -ArchivePath "D:\LogRhythmArchives\InactiveTest" -RetentionDays 90 -Execute -Verbose

# Process with custom log location
.\ArchiveRetention.ps1 -ArchivePath "D:\LogRhythmArchives" -RetentionDays 60 -LogPath "C:\Logs\archive_retention.log" -Execute
```

### Scheduled Task Example

Create a scheduled task to run the script weekly:

```powershell
$action = New-ScheduledTaskAction -Execute 'PowerShell.exe' -Argument '-NoProfile -ExecutionPolicy Bypass -File "C:\LogRhythm\Scripts\ArchiveV2\ArchiveRetention.ps1" -ArchivePath "D:\LogRhythmArchives" -RetentionDays 120 -Execute -Verbose'
$trigger = New-ScheduledTaskTrigger -Weekly -DaysOfWeek Sunday -At 2am
$settings = New-ScheduledTaskSettingsSet -StartWhenAvailable -DontStopOnIdleEnd -RunOnlyIfNetworkAvailable
Register-ScheduledTask -Action $action -Trigger $trigger -Settings $settings -TaskName "LogRhythm Archive Retention" -Description "Runs LogRhythm archive retention weekly" -User "SYSTEM" -RunLevel Highest
```

> **Note**: Run the scheduled task as SYSTEM or a service account with appropriate permissions.

## Parameters

| Parameter         | Description                                               | Default/Required         |
|-------------------|----------------------------------------------------------|-------------------------|
| `-ArchivePath`    | Path to LogRhythm archive directory                      | Required                |
| `-RetentionDays`  | Number of days to retain archive files                   | Required                |
| `-Execute`        | Perform actual file deletions (otherwise dry-run)        | `$false`                |
| `-LogPath`        | Path to log file                                         | `./ArchiveRetention.log`|
| `-MaxConcurrency` | Maximum number of concurrent operations                  | `8`                     |
| `-BatchSize`      | Number of files to process in each batch                 | `2000`                  |
| `-Verbose`        | Show detailed output during execution                    | `$false`                |

## Best Practices

1. **Always test first**: Run without `-Execute` to verify which files will be deleted
2. **Check disk space**: Ensure you have sufficient space before running with `-Execute`
3. **Start with a subset**: Test with a smaller directory first
4. **Review logs**: Check the log file after each run for any warnings or errors
5. **Schedule during off-peak**: Run during maintenance windows but not at the same time as other processes to minimize impact
6. **Monitor progress**: The script provides real-time progress updates
7. **Archive logs**: Regularly back up all script logs for compliance, auditing, and troubleshooting. This includes:
   - The current main script log (`script_logs/ArchiveRetention.log`)
   - Rotated/archived script logs (`script_logs/rotated_logs/ArchiveRetention_*.log`)
   - Retention action logs (`retention_actions/retention_*.log`)
8. **Backup first**: Ensure you have backups before running with `-Execute`

## Troubleshooting

### Common Issues

1. **Access Denied**
   - Ensure the script is run with administrative privileges
   - Verify the account has Full Control permissions on the archive directory

2. **Files Not Being Deleted**
   - Check if the files are older than the specified retention period
   - Verify the path is correct and accessible
   - Ensure no other processes have the files locked

3. **Performance Issues**
   - For large directories, consider increasing `-BatchSize`
   - Reduce `-MaxConcurrency` if system resources are constrained
   - Avoid running during peak hours

4. **Log File Growth**
   - Logs automatically rotate when they reach 10MB
   - Up to 5 log files are kept by default

5. **Minimum retention not honored:**
   - The script will never delete files newer than 90 days, regardless of the value you specify with `-Execute`.
   - Dry-run will show what would be deleted for any value, but will warn if below 90.

## Version History

> **Versioning Note:** The authoritative version is defined in `ArchiveRetention.ps1` (`$SCRIPT_VERSION`).

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

**Disclaimer:**  
This script is provided "as is", without warranty of any kind. Use at your own risk.

- **Access Denied**: Ensure the script runs with appropriate permissions
- **No files processed**: Verify the `-ArchivePath` is correct and contains `.lca` files
- **Unexpected deletions**: Always test with `-Verbose` first to review actions
- **Log file issues**: Check disk space and permissions for the log directory

## Support

Contributions are welcome! Please follow the standard GitHub fork and pull request workflow.

## Author

Nathan Church  
nathan.church@exabeam.com  
Exabeam Professional Services

## Version

v2.0 - June 2025  
- Complete rewrite with improved error handling and logging
- Fixed empty message parameter binding issues
- Enhanced logging and progress tracking
- Optimized for LogRhythm archive management
