# LogRhythm Archive Retention Manager

> **Versioning Note:** The authoritative version is defined in `ArchiveRetention.ps1` (`$SCRIPT_VERSION`).

## Table of Contents
- [Disclaimer](#disclaimer)
- [Features](#features)
- [Requirements](#requirements)
- [Installation](#installation)
- [Usage](#usage)
- [Credential Management](#credential-management)
- [Parameters](#parameters)
- [Best Practices](#best-practices)
- [Testing & Validation](#testing--validation)
- [Troubleshooting](#troubleshooting)
- [Logging](#logging)
- [License](#license)
- [Support](#support)
- [Author](#author)

---

## Disclaimer

**Use at your own risk.** This script deletes files according to your parameters. Ensure you have backups and test thoroughly in a non-production environment before production use. The authors are not liable for any data loss or damages.

---

This is a high-performance PowerShell script for managing the retention of files, particularly LogRhythm Inactive Archives. It automates the cleanup of old archive files while providing detailed logging and reporting. The latest version includes performance optimizations and enhanced logging capabilities.

This script is specifically designed for use with LogRhythm (LR7 SIEM) environments, targeting the files generated by the [Data Processor's InactiveArchivePath value](https://docs.logrhythm.com/lrsiem/docs/change-archive-location). LR7 Inactive Archives contain the raw logs collected by LR System Monitor Agents and saved by the LogRhythm Mediator Server Service. The LR7 SIEM does not delete these files and so users must manage its retention using other methods, such as this script. Retaining these archive log files (.lca) allows you to utilize LogRhythm's SecondLook Wizard to reprocess and reindex the logs back into the SIEM, if needed. Inactive Archives do not affect the current searchability (indexing) of the SIEM. **Warning:** Do not configure this script to target LogRhythm's Active Archives (.lua). These are configured within the product with a value of 1 to 7 days and then automatically age into the Inactive Archive path.

## Features

- **Safe Execution**: Dry-run mode by default, requires `-Execute` flag for actual deletions
- **Minimum Retention Enforcement**: The script will never delete files newer than $MINIMUM_RETENTION_DAYS, which is hard-coded in the script for safety (default: 90 days, configurable by editing the script). If you specify a lower value with `-Execute`, the script will log a warning and enforce the minimum. Dry-run mode will warn but proceed with any value, showing what would be in scope for deletion with the given parameters.
- **Comprehensive Logging & Auditing**: All script activity is logged with timestamps, including file statistics, progress updates, error handling, and detailed output with `-Verbose`. In execute mode, every file deleted is also recorded in a dedicated audit log (`retention_actions/retention_*.log`) for compliance and traceability. Dry-run mode will show what would be deleted, but only actual deletions are audit-logged.
- **Flexible Configuration**: Customize retention periods (e.g., `-RetentionDays 1095`), archive locations (`-ArchivePath`), and file types to include (default: `.lca`).
- **Performance Optimized**: Efficient file scanning and processing, with real-time progress updates and robust error handling.

## Requirements

- Windows Server
- PowerShell 5.1 or later
- Sufficient permissions on archive directories (local or UNC share)

## Installation

1. Copy the `ArchiveRetention.ps1` script to the Windows server
2. Place it in a directory with appropriate permissions (e.g., `C:\LogRhythm\Scripts\LRArchiveRetention\`) so that only authorized administrators can modify or execute the script
3. Ensure the script has read/write permissions to the archive directories

## Usage

```powershell
# Show help and available parameters
.\ArchiveRetention.ps1 -Help

# Dry run for a local path (shows what would be deleted)
.\ArchiveRetention.ps1 -ArchivePath "D:\LogRhythmArchives\Inactive" -RetentionDays 90

# Live execution for a local path (deletes files)
.\ArchiveRetention.ps1 -ArchivePath "D:\LogRhythmArchives\Inactive" -RetentionDays 90 -Execute

# Live execution for a network share using a saved credential
.\ArchiveRetention.ps1 -CredentialTarget "NAS_CRED" -RetentionDays 180 -Execute
```

> **Note:** The script will never delete files newer than the minimum retention (default: 90 days), even if you specify a lower value with `-Execute`.

## Credential Management

For network shares, use a secure two-step process:

**Step 1: Save Credentials (One-Time Setup)**
Use the included `Save-Credential.ps1` helper script. It will test the credentials against the share before saving.

*   **Interactive Method (Prompt for password):**
    ```powershell
    # Save credentials for a network share, prompting for username/password
    .\Save-Credential.ps1 -Target "NAS_CRED" -SharePath "\\10.20.1.7\LRArchives"
    ```
*   **Secure Non-Interactive Method (Recommended for automation):**
    ```powershell
    # Pipe the password to the script to avoid storing it in history or process lists
    echo "YourSecurePassword" | .\Save-Credential.ps1 -Target "NAS_CRED" -SharePath "\\10.20.1.7\LRArchives" -UseStdin -Quiet
    ```

**Step 2: Use Saved Credential**
Reference the credential by the `-Target` name you chose. The script will automatically handle mapping the network drive.
```powershell
# Use the saved credential (no need to specify the share path again)
.\ArchiveRetention.ps1 -CredentialTarget "NAS_CRED" -RetentionDays 180

# With execution
.\ArchiveRetention.ps1 -CredentialTarget "NAS_CRED" -RetentionDays 180 -Execute
```

**Security Notes:**
- Credentials are encrypted using the Windows Data Protection API (DPAPI) and stored securely on the machine where they were created.
- Never hard-code passwords in scripts. Always use the `-UseStdin` parameter or interactive prompts.

## Parameters

| Parameter              | Type         | Required | Description                                                                 |
|------------------------|--------------|----------|-----------------------------------------------------------------------------|
| `-ArchivePath`         | string       | Yes      | Path to local directory or network share. Not needed if using `-CredentialTarget`. |
| `-CredentialTarget`    | string       | Yes      | Name of saved credential for network share. Not needed if using `-ArchivePath`. |
| `-RetentionDays`       | int          | Yes      | Number of days to retain files.                                             |
| `-Execute`             | switch       | No       | Actually deletes files. If omitted, the script runs in safe dry-run mode.   |
| `-Verbose`             | switch       | No       | Enables detailed, step-by-step logging to the console during execution.     |
| `-LogPath`             | string       | No       | Custom path to the script's log file (default: `script_logs` folder).       |
| `-MaxRetries`          | int          | No       | Max retries for failed file deletions (default: 3).                         |
| `-RetryDelaySeconds`   | int          | No       | Delay between deletion retries in seconds (default: 1).                     |
| `-SkipDirCleanup`      | switch       | No       | Skips the final step of removing empty directories after file processing.   |
| `-IncludeFileTypes`    | string[]     | No       | File extensions to include, e.g., `@('.lca', '.txt')` (default: `@('.lca')`).|

## Best Practices

1. **Backup first**: Ensure you have backups before running with `-Execute`
2. **Test with dry-run**: Use dry-run and `-Verbose` to verify what will be deleted
3. **Start small**: Test on a subset before running on large datasets
4. **Review logs**: Check logs after each run for warnings or errors
5. **Schedule wisely**: Run during maintenance windows, not during peak hours
6. **Use UNC paths**: For network shares, always use UNC paths (e.g., `\\server\share`)
7. **Run as appropriate user**: Ensure the script runs with sufficient permissions

## Testing & Validation

> **Note:** This section is for end users. For developer and automated test plans, see the `/tests` directory.

**How to Safely Test the Script:**
1. **Dry Run**:
   - Run the script without `-Execute` to see what files would be deleted.
   - Example:
     ```powershell
     .\ArchiveRetention.ps1 -ArchivePath "D:\LogRhythmArchives\Inactive" -RetentionDays 90
     ```
   - Review the output and logs to confirm only the intended files are in scope.
2. **Test with a Small Directory**:
   - Use a test directory with sample files to validate behavior.
   - Adjust `-RetentionDays` to test edge cases (e.g., files just above/below the threshold).
3. **Check Logs**:
   - Review `script_logs/ArchiveRetention.log` for a summary and any warnings/errors.
   - In dry-run, no files are deleted; in execute mode, check `retention_actions/retention_*.log` for audit trail.
4. **Validate Results**:
   - After running with `-Execute`, verify that only files older than the retention period are deleted.
   - Confirm no newer files or unintended files are affected.
5. **Restore from Backup (if needed)**:
   - Always ensure you can restore files from backup before running in production.

## Troubleshooting

| Issue                        | Possible Causes & Solutions                                                                 |
|------------------------------|------------------------------------------------------------------------------------------|
| Access Denied                | Run as admin; check share and NTFS permissions; verify account context                    |
| Files Not Being Deleted      | Files may not meet retention; check path and permissions; ensure files are not locked     |
| Mapped Drives Not Available  | Use UNC paths; mapped drives are session-specific                                         |
| File Not Found Errors        | Check for broken shortcuts, inaccessible subfolders, long paths, or special characters    |
| 'Access is denied'           | Insufficient permissions; check both share and NTFS permissions                           |
| Performance Issues           | Run during off-peak; ensure server/network can handle load                                |
| Log File Growth              | Main log rotates at 10MB; archive/rotate retention logs as needed                        |
| Minimum Retention Not Honored| Script enforces minimum retention in execute mode                                         |

- For more details, see logs in `script_logs/` and `retention_actions/`.

## Logging

| Log File Location                        | Description                                                      |
|-------------------------------------------|------------------------------------------------------------------|
| `script_logs/ArchiveRetention.log`        | Main script log (current run): all activity, config, progress    |
| `script_logs/ArchiveRetention_*.log`      | Rotated/archived main logs (previous runs, timestamped)          |
| `retention_actions/retention_*.log`       | Audit logs: every file deleted in execute mode                   |

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

## Support

Contributions are welcome! Please follow the standard GitHub fork and pull request workflow.

## Author

Nathan Church  
Exabeam Professional Services

